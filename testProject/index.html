<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyCounter</title>
    <!-- Boostrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!-- Css -->
    <link rel="stylesheet" href="css/style.css">
    <!-- IDB -->
    <script src="https://cdn.jsdelivr.net/npm/idb@3.0.2/build/idb.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="d-flex align-items-center justify-content-center py-3 border-bottom">
            <a href="#" class="text-decoration-none me-md-auto md-0"><p class="p-0 text-dark fs-4">MoneyCounter</p></a>
            <ul class="nav">
                <ul class="nav-item"><a class="nav-link active" href="#">Главная</a></ul>
                <ul class="nav-item"><a class="nav-link text-secondary" href="#">Расходы</a></ul>
                <ul class="nav-item"><a class="nav-link text-secondary" href="#">Доходы</a></ul>
                <ul class="nav-item"><a class="nav-link text-secondary" href="#">Подсчет</a></ul>
            </ul>
        </header>
        <main>
            <div class="mt-lg-5">
                <h1 class="h1 text-center mb-lg-5">Все расходы и доходы</h1>
                <div class="">
                    <div class="mb-lg-5">
                        <h2 class="mb-3">Расходы</h2>
                        <table class="table" id="costsTable">
                            <thead>
                                <tr>
                                    <th>Магазин</th>
                                    <th>Категория</th>
                                    <th>Товары</th>
                                    <th>Cтоимость</th>
                                    <th>Дата</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNewCostModal">Добавить</button>
                    </div>
                    <div>
                        <h2 class="mb-3">Зачисления</h2>
                        <table class="table" id="incomeTable">
                            <thead>
                                <tr>
                                    <th>Наименование</th>
                                    <th>Количество</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Пример</td>
                                    <td>30000рлк</td>
                                </tr>
                            </tbody>
                        </table>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNewIncomeModal">Добавить</button>
                    </div>
                </div>
            </div>








            <!-- ModalWindows -->

            <!-- AddNewCostModal -->
            <div class="modal fade" id="addNewCostModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="staticBackdropLabel">Добавление нового расхода</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <label for="store" class="form-label">Магазин</label>
                        <input type="text" class="form-control" id="store">
                      </div>
                      <div class="mb-3">
                        <label for="store" class="form-label">Категория</label>
                        <input type="text" class="form-control" id="category">
                      </div>
                      <div class="mb-3">
                        <label for="tableCostItem">Товары</label>
                        <table class="table" id="tableCostItem">
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Количество</th>
                                    <th>Цена</th>    
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th><input type="text" class="form-control" name="tovarName"></th>
                                    <th><input type="text" class="form-control" name="tovarCount"></th>
                                    <th><input type="text" class="form-control" name="tovarPrice"></th>
                                </tr>
                            </tbody>
                          </table>
                          <div class="d-flex justify-content-end">
                            <button class="btn btn-primary" onclick="addTovarToTable()">Добавить товар</button>    
                          </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                      <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="addNewCost()">Добавить</button>
                    </div>
                  </div>
                </div>
            </div>

            <!-- addIncomeTable -->
            <div class="modal fade" id="addNewIncomeModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="staticBackdropLabel">Добавление нового дохода</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <label for="nameIncome" class="form-label">Наименование</label>
                        <input type="text" class="form-control" id="nameIncome">
                      </div>
                      <div class="mb-3">
                        <label for="countIncome" class="form-label">Количество</label>
                        <input type="text" class="form-control" id="countIncome">
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                      <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="clearModalIncome()">Добавить</button>
                    </div>
                  </div>
                </div>
            </div>

        </main>
        <footer>

        </footer>
    </div>

    
    
    


    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <script>
        //Инициализация бд
        let db;
        init();
        async function init(){
            db=await idb.openDb('moneyCounterDb',1,db=>{
                db.createObjectStore('costs',{keyPath: 'id'});
                db.createObjectStore('incomes',{keyPath: 'id'});
            });  
            viewCosts();  
        };

        //Добавление нового товара в таблицу с расходами
        function addTovarToTable(){
            let tbody=tableCostItem.children[1];
            let tr=document.createElement('tr');
            tr.innerHTML="<th><input type='text' class='form-control' name='tovarName'></th><th><input type='text' class='form-control' name='tovarCount'></th><th><input type='text' class='form-control' name='tovarPrice'></th>";
            tbody.append(tr);
        }

        //Очистка инпутов при закрытии модального окна
        function clearModalCosts(){
            console.log('modal clear!');
            store.value='';
            category.value='';
            let tbody=tableCostItem.children[1];
            tbody.innerHTML="<th><input type='text' class='form-control' name='tovarName'></th><th><input type='text' class='form-control' name='tovarCount'></th><th><input type='text' class='form-control' name='tovarPrice'></th>";
        }

        //Очистка модального окна доходов
        function clearModalIncome(){
            nameIncome.value='';
            countIncome.value='';
        }



        //Вывод расходов в таблицу
        async function viewCosts(){
            let tbody=costsTable.children[1];
            let costs=await getCosts();
            tbody.innerHTML='';
            if(costs.length){
                for(let i=0;i<costs.length;i++){
                    //Создание tr и td
                    let tr=document.createElement('tr');
                    let tdStore=document.createElement('td');
                    let tdCategory=document.createElement('td');
                    let tdTovars=document.createElement('td');
                    let tdPrice=document.createElement('td');
                    let tdDate=document.createElement('td');
                    let redactBtnTd=document.createElement('td');
                    let delBtnTd=document.createElement('td');

                    //кнопки для td
                    //кнопка редактирования
                    let redactBtn=document.createElement('button');
                    redactBtn.value=costs[i].id;
                    redactBtn.className="btn btn-primary";
                    redactBtn.textContent="Редактировать";
                    redactBtnTd.append(redactBtn);

                    //кнопка удаления
                    let delBtn=document.createElement('button');
                    delBtn.value=costs[i].id;
                    delBtn.className="btn btn-danger";
                    delBtn.textContent="Удалить";
                    delBtn.onclick=function(){
                        if(confirm('Точно хотите удалить?')){
                            removeCost(this.value);
                        }
                    };
                    delBtnTd.append(delBtn);

                    //стандартные данные
                    tdStore.innerHTML=costs[i].store;
                    tdCategory.innerHTML=costs[i].category;    
                    let date=new Date(costs[i].date);
                    tdDate.innerHTML=date.getFullYear()+'.'+date.getMonth()+'.'+date.getDate();

                    //перебор товаров в покупке
                    let items='';
                    for(let j=0;j<costs[i].items.length;j++){
                        items+=costs[i].items[j].name+": "+costs[i].items[j].amount+", ";
                    }
                    items=items.slice(0,items.length-2);
                    tdTovars.innerHTML=items;
                    tdPrice.innerHTML=costs[i].fullprice;

                    //занесение в tr
                    tr.append(tdStore);
                    tr.append(tdCategory);
                    tr.append(tdTovars);
                    tr.append(tdPrice);
                    tr.append(tdDate);
                    tr.append(redactBtnTd);
                    tr.append(delBtnTd);
                    
                    //занесение в таблицу
                    tbody.append(tr);
                }
            }
            else{
                tableCostItem.innerHTML='Записей еще нет!'
            }
        }

        //Добавление новой затраты
        async function addNewCost(){
            let items=tableCostItem.children[1].children;
            let tovars=[];
            for(let i=0;i<items.length;i++){
                tovars.push({name: items[i].getElementsByTagName('input')[0].value, 
                    amount: items[i].getElementsByTagName('input')[1].value,
                    price: items[i].getElementsByTagName('input')[2].value
                })
            }
            let cost=createCost(store.value,category.value,tovars);
            await addCost(cost);

            clearModalCosts();
            viewCosts();
        }

        //Удаление затраты          
        async function removeCost(id){
            console.log(id);
            let tr=db.transaction('costs','readwrite');
            let costsStore=tr.objectStore('costs');            
            await costsStore.delete(+id);
            viewCosts();
        }














        //Получение затрат
        async function getCosts(){
            let tr=db.transaction('costs');
            let costsStore=tr.objectStore('costs');
            costs=await costsStore.getAll();
            return costs;
        };

        //Получение доходов
        async function getIncomes(){
            let tr=db.transaction('incomes');
            let incomesStore=tr.objectStore('incomes');
            let incomes=incomesStore.getAll();
            return incomes;
        }

        //Добавление расхода
        async function addCost(obj,id){
            let tx=db.transaction('costs','readwrite');
            let request =await tx.objectStore('costs').add(obj);
            request.onerror=function(event){
                if(event.error.name=='ConstraintError'){
                    //Позже допишу
                }
            }
        };

        //Добавление дохода
        async function addIncome(name,amount){
            let tx=db.transaction('incomes','readwrite');
            let request=await tx.objectStore('incomes').add(createIncome(name,amount));
            request.onerror=function(event){
                if(event.error.name=='ConstraintError'){
                    //Позже допишу
                }
            }
        }

        //Рандомный id
        function getRandomId(){
            return +(1+Math.random()*(1e6-1)).toFixed();
        }
        //Объекты для добавления

        //Расход
        function createCost(store,category,items){
            let fullPrice;
            console.log(items);
            if(items.length>1){
                fullPrice=items.reduce((a,b)=>(+a.price+ +b.price));
            }
            else{
                fullPrice=items[0].price;
            }
            return {
                id:getRandomId(),
                store:store,
                category:category,
                items:items,
                fullprice:fullPrice,
                date:Date.now(),
            }
        }
        //Доход
        function createIncome(name,amount){
            return {
                id:getRandomId(),
                name:name,
                amount:amount,
                date:Date.now(),
            }
        }

        
    </script>
</body>
</html>