<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyCounter</title>
    <!-- Boostrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!-- Css -->
    <link rel="stylesheet" href="css/style.css">
    <!-- IDB -->
    <script src="https://cdn.jsdelivr.net/npm/idb@3.0.2/build/idb.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="d-flex align-items-center justify-content-center py-3 border-bottom">
            <a href="#" class="text-decoration-none me-md-auto md-0"><p class="p-0 text-dark fs-4">MoneyCounter</p></a>
            <ul class="nav">
                <ul class="nav-item"><a class="nav-link active" href="#">Главная</a></ul>
                <ul class="nav-item"><a class="nav-link text-secondary" href="#">Расходы</a></ul>
                <ul class="nav-item"><a class="nav-link text-secondary" href="#">Доходы</a></ul>
                <ul class="nav-item"><a class="nav-link text-secondary" href="#">Подсчет</a></ul>
            </ul>
        </header>
        <main>
            <div class="mt-lg-3 mb-lg-3">
                <h1 class="h1 text-center">Результат за последние 30 дней</h1>
                <div class="d-flex flex-column align-items-center justify-items-center">
                    <div id="resMounth">
                        <p>Общие доходы за месяц составляют: <span class="text-success"><b>da</b></span></p>
                        <p>Общие расходы за месяц составляют: <span class="text-danger"><b>net</b></p>
                        <p></p>
                    </div>
                </div>
            </div>

            <div>
                <h1>График затрат за последнюю неделю</h1>
                <canvas class="my-4 w-100" id="chart" width="900" height="380"></canvas>
            </div>
            <div>
                <h1>Расходы за все время</h1>

            </div>





            <div class="mt-lg-5">
                <h1 class="h1 text-center mb-lg-5">Управление расходами и зачислениями</h1>
                <div class="">
                    <div class="mb-lg-5">
                        <h2 class="mb-3">Расходы</h2>
                        <table class="table" id="costsTable">
                            <thead>
                                <tr>
                                    <th>Магазин</th>
                                    <th>Категория</th>
                                    <th>Товары</th>
                                    <th>Cтоимость</th>
                                    <th>Дата</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNewCostModal" onclick="clearModalCosts()">Добавить</button>
                    </div>
                    <div>
                        <h2 class="mb-3">Зачисления</h2>
                        <table class="table" id="incomeTable">
                            <thead>
                                <tr>
                                    <th>Наименование</th>
                                    <th>Количество</th>
                                    <th>Дата</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNewIncomeModal" onclick="clearModalIncome()">Добавить</button>
                    </div>
                </div>
            </div>








            <!-- ModalWindows -->

            <!-- AddNewCostModal -->
            <div class="modal fade" id="addNewCostModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="staticBackdropLabel">Добавление нового расхода</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <label for="store" class="form-label">Магазин</label>
                        <input type="text" class="form-control" id="store">
                      </div>
                      <div class="mb-3">
                        <label for="store" class="form-label">Категория</label>
                        <input type="text" class="form-control" id="category">
                      </div>
                      <div class="mb-3">
                        <label for="tableCostItem">Товары</label>
                        <table class="table" id="tableCostItem">
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Количество</th>
                                    <th>Цена</th>
                                    <th></th>   
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" class="form-control" name="tovarName"></td>
                                    <td><input type="text" class="form-control" name="tovarCount"></td>
                                    <td><input type="text" class="form-control" name="tovarPrice"></td>
                                    <td><button class="btn btn-danger">Удалить</button></td>
                                </tr>
                            </tbody>
                          </table>
                          <div class="d-flex justify-content-end">
                            <button class="btn btn-primary" onclick="addTovarToTable()">Добавить товар</button>    
                          </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                      <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="addNewCost()" id="addBtnModalCost">Добавить</button>
                    </div>
                  </div>
                </div>
            </div>

            <!-- addIncomeTable -->
            <div class="modal fade" id="addNewIncomeModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="staticBackdropLabel">Добавление нового дохода</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <label for="nameIncome" class="form-label">Наименование</label>
                        <input type="text" class="form-control" id="nameIncome">
                      </div>
                      <div class="mb-3">
                        <label for="countIncome" class="form-label">Количество</label>
                        <input type="text" class="form-control" id="countIncome">
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                      <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="addNewIncome()" id="addBtnModalIncome">Добавить</button>
                    </div>
                  </div>
                </div>
            </div>
        </main>
        <footer>

        </footer>
    </div>

    
    
    


    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <!-- Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js" integrity="sha384-zNy6FEbO50N+Cg5wap8IKA4M/ZnLJgzc6w2NqACZaK0u0FXfOWRRJOnQtpZun8ha" crossorigin="anonymous"></script>
    <script>
        //Инициализация бд
        let db;
        init();
        async function init(){
            db=await idb.openDb('moneyCounterDb',1,db=>{
                db.createObjectStore('costs',{keyPath: 'id'});
                db.createObjectStore('incomes',{keyPath: 'id'});
            });  
            viewIncomes();
            viewCosts(); 
            viewResult(); 
            createChart();
        };

        //Добавление нового товара в таблицу с расходами
        function addTovarToTable(){
            let tbody=tableCostItem.children[1];
            let tr=document.createElement('tr');
            tr.innerHTML="<td><input type='text' class='form-control' name='tovarName'></td><td><input type='text' class='form-control' name='tovarCount'></td><td><input type='text' class='form-control' name='tovarPrice'></td><td><button class='btn btn-danger' onclick='removeStroke(event)'>Удалить</button></td>";
            tbody.append(tr);
        }

        //Очистка инпутов при закрытии модального окна
        function clearModalCosts(){
            console.log('modal clear!');
            store.value='';
            category.value='';
            addBtnModalCost.innerHTML='Добавить';
            addBtnModalCost.onclick=function(){
                addNewCost();
            }
            addNewCostModal.getElementsByTagName('h5')[0].innerHTML="Добавление нового расхода";
            let tbody=tableCostItem.children[1];
            tbody.innerHTML="<td><input type='text' class='form-control' name='tovarName'></td><td><input type='text' class='form-control' name='tovarCount'></th><th><input type='text' class='form-control' name='tovarPrice'></td><td><button class='btn btn-danger' onclick='removeStroke(event)'>Удалить</button></td>";
        }

        //Очистка модального окна доходов
        function clearModalIncome(){
            nameIncome.value='';
            countIncome.value='';
            addBtnModalIncome.innerHTML='Добавить';
            addNewIncomeModal.getElementsByTagName('h5')[0].innerHTML="Добавление нового дохода";
            addBtnModalIncome.onclick=function(){
                addNewIncome();
            }
        }



        //Вывод расходов в таблицу
        async function viewCosts(){
            createChart()
            let tbody=costsTable.children[1];
            let costs=await getCosts();
            viewResult();
            tbody.innerHTML='';
            let summ=0;
            if(costs.length){
                for(let i=0;i<costs.length;i++){
                    summ+=+costs[i].fullprice;
                    //Создание tr и td
                    let tr=document.createElement('tr');
                    let tdStore=document.createElement('td');
                    let tdCategory=document.createElement('td');
                    let tdTovars=document.createElement('td');
                    let tdPrice=document.createElement('td');
                    let tdDate=document.createElement('td');
                    let redactBtnTd=document.createElement('td');
                    let delBtnTd=document.createElement('td');

                    //кнопки для td
                    //кнопка редактирования
                    let redactBtn=document.createElement('button');
                    redactBtn.value=costs[i].id;
                    redactBtn.className="btn btn-primary";
                    redactBtn.textContent="Редактировать";
                    redactBtn.setAttribute('data-bs-target',"#addNewCostModal");
                    redactBtn.setAttribute('data-bs-toggle',"modal");
                    redactBtn.onclick=function(){
                        viewRedactCost(this.value);
                    };

                    redactBtnTd.append(redactBtn);
                    //кнопка удаления
                    let delBtn=document.createElement('button');
                    delBtn.value=costs[i].id;
                    delBtn.className="btn btn-danger";
                    delBtn.textContent="Удалить";
                    delBtn.onclick=function(){
                        if(confirm('Точно хотите удалить?')){
                            removeCost(this.value);
                        }
                    };
                    delBtnTd.append(delBtn);

                    //стандартные данные
                    tdStore.innerHTML=costs[i].store;
                    tdCategory.innerHTML=costs[i].category;    
                    let date=new Date(costs[i].date);
                    tdDate.innerHTML=date.getFullYear()+'.'+date.getMonth()+'.'+date.getDate();

                    //перебор товаров в покупке
                    let items='';
                    for(let j=0;j<costs[i].items.length;j++){
                        items+=costs[i].items[j].name+": "+costs[i].items[j].amount+", ";
                    }
                    items=items.slice(0,items.length-2);
                    tdTovars.innerHTML=items;
                    tdPrice.innerHTML=costs[i].fullprice+' Рлк.';

                    //занесение в tr
                    tr.append(tdStore);
                    tr.append(tdCategory);
                    tr.append(tdTovars);
                    tr.append(tdPrice);
                    tr.append(tdDate);
                    tr.append(redactBtnTd);
                    tr.append(delBtnTd);
                    
                    //занесение в таблицу
                    tbody.append(tr);
                }
                let summTr=document.createElement('tr');
                summTr.innerHTML=`<tr><td><b>Итого</b></td><td></td><td></td><td> ${summ} Рлк. </td><td></td><td></td><td></td></tr>`
                tbody.append(summTr);
            }
            else{
                tbody.innerHTML='Записей еще нет!'
            }
        }

        //Добавление новой затраты
        async function addNewCost(){
            
            let items=tableCostItem.children[1].children;
            let tovars=[];
            for(let i=0;i<items.length;i++){
                tovars.push({name: items[i].getElementsByTagName('input')[0].value, 
                    amount: items[i].getElementsByTagName('input')[1].value,
                    price: items[i].getElementsByTagName('input')[2].value
                })
            }
            let cost=createCost(store.value,category.value,tovars);
            await addCost(cost);

            clearModalCosts();
            viewCosts();
        }

        //Удаление затраты          
        async function removeCost(id){
            let tr=db.transaction('costs','readwrite');
            let costsStore=tr.objectStore('costs');            
            await costsStore.delete(+id);
            viewCosts();
        }

        //Вывод всех доходов

        async function viewIncomes(){
            let tbody=incomeTable.children[1];
            let incomes=await getIncomes();
            viewResult();
            if(incomes.length){
                let summ=0;
                tbody.innerHTML='';
                for(let i=0;i<incomes.length;i++){
                    summ+=incomes[i].amount;

                    let tr=document.createElement('tr');
                    let nameTd=document.createElement('td');
                    let amountTd=document.createElement('td');
                    let dateTd=document.createElement('td');
                    let redactBtnTd=document.createElement('td');
                    let delBtnTd=document.createElement('td');

                    //кнопки для td
                    //кнопка редактирования
                    let redactBtn=document.createElement('button');
                    redactBtn.value=incomes[i].id;
                    redactBtn.className="btn btn-primary";
                    redactBtn.textContent="Редактировать";
                    redactBtn.setAttribute('data-bs-target',"#addNewIncomeModal");
                    redactBtn.setAttribute('data-bs-toggle',"modal");
                    redactBtn.onclick=function(){
                        viewRedactIncome(this.value);
                    };

                    redactBtnTd.append(redactBtn);

                    //кнопка удаления
                    let delBtn=document.createElement('button');
                    delBtn.value=incomes[i].id;
                    delBtn.className="btn btn-danger";
                    delBtn.textContent="Удалить";
                    delBtn.onclick=function(){
                        if(confirm('Точно хотите удалить?')){
                            removeIncome(this.value);
                        }
                    };
                    delBtnTd.append(delBtn);

                    nameTd.innerHTML=incomes[i].name;
                    amountTd.innerHTML=incomes[i].amount+ ' Рлк.';
                    let date=new Date(incomes[i].date);
                    dateTd.innerHTML=date.getFullYear()+'.'+date.getMonth()+'.'+date.getDate();

                    tr.append(nameTd);
                    tr.append(amountTd);
                    tr.append(dateTd);
                    tr.append(redactBtnTd);
                    tr.append(delBtnTd);

                    tbody.append(tr);
                }
                let summTr=document.createElement('tr');
                summTr.innerHTML=`<tr><td><b>Итого</b></td><td>${summ} Рлк.</td><td></td><td></td><td></td></tr>`;
                tbody.append(summTr);
            }
            else{
                tbody.innerHTML="Доходов пока что нет"
            }
        }


        //Добавление нового дохода
        async function addNewIncome(){
            let obj=createIncome(nameIncome.value, +countIncome.value);
            await addIncome(obj);
            viewIncomes();
            clearModalIncome();
        }

        //Удаление дохода
        async function removeIncome(id){
            let tr=db.transaction('incomes','readwrite');
            let costsStore=tr.objectStore('incomes');            
            await costsStore.delete(+id);
            viewIncomes();
        }

        //Показ редактируемого расхода
        async function viewRedactCost(id){
            addBtnModalCost.innerHTML='Изменить';
            addBtnModalCost.value=id;
            addBtnModalCost.onclick=function(){
                redactCost(this.value);
            }
            addNewCostModal.getElementsByTagName('h5')[0].innerHTML="Изменение расхода";

            let obj=await getCosts(id);
            store.value=obj.store;
            category.value=obj.category;
            let tbody=tableCostItem.children[1];
            tbody.innerHTML='';
            for(let i=0;i<obj.items.length;i++){
                let tr=document.createElement('tr');
                tr.innerHTML=`<td><input type='text' class='form-control' name='tovarName' value='${obj.items[i].name}'></td><td><input type='text' class='form-control' name='tovarCount' value='${obj.items[i].amount}'></td><td><input type='text' class='form-control' name='tovarPrice' value='${obj.items[i].price}'></td><td><button class='btn btn-danger' onclick='removeStroke(event)'>Удалить</button></td>`
                tbody.append(tr);
            }
        }

        //Удаление товара

        function removeStroke(event){
            console.log(event.target.parentNode.parentNode.remove());
        }

        //Редактирование расхода
        async function redactCost(id){
            let cost=await getCosts(id);

            cost.store=store.value;
            cost.category=category.value;
            
            let items=tableCostItem.children[1].children;
            let tovars=[];
            for(let i=0;i<items.length;i++){
                tovars.push({name: items[i].getElementsByTagName('input')[0].value, 
                    amount: items[i].getElementsByTagName('input')[1].value,
                    price: items[i].getElementsByTagName('input')[2].value
                })
            }
            if(items.length>1){
                //cost.fullprice=tovars.reduce((a,b)=>(+a.price + +b.price));
                cost.fullprice=summPriceItems(tovars);
            }
            else{
                cost.fullprice=tovars[0].price;
            }
            cost.items=tovars;
            redCost(cost);

            clearModalCosts();
            viewCosts();
        }

        function summPriceItems(items){
            let summ=0;
            for(let i=0;i<items.length;i++){
                summ+=+items[i].price;
            }
            return summ;
        }

        //Показ редактируемого дохода
        async function viewRedactIncome(id){
            let income=await getIncomes(id);

            nameIncome.value=income.name;
            countIncome.value=income.amount;
            addBtnModalIncome.innerHTML='Изменить';
            addBtnModalIncome.value=id;
            addBtnModalIncome.onclick=function(){
                redactIncome(this.value);
            }
            addNewIncomeModal.getElementsByTagName('h5')[0].innerHTML="Изменение дохода";
        } 
        //Редактирование дохода
        async function redactIncome(id){
            let income=await getIncomes(id);
            income.name=nameIncome.value;
            income.amount=+countIncome.value;
            await redIncome(income);
            clearModalIncome();
            viewIncomes();
        }

        //Показ результата за последние 30 дней(потом допишу)
        async function viewResult(){
            let incomes=await getIncomes();
            let costs=await getCosts();
            let incomeSumm=0;
            let costsSumm=0;

            for(let i=0;i<incomes.length;i++){
                incomeSumm+=+incomes[i].amount;
            }
            for(let i=0;i<costs.length;i++){
                for(let j=0;j<costs[i].items.length;j++){
                    costsSumm+=+costs[i].items[j].price;
                }
            }
            let out=resMounth.getElementsByTagName('b');
            out[0].innerHTML=incomeSumm+' Рлк.';
            out[1].innerHTML=costsSumm+' Рлк.';

            if(incomeSumm>costsSumm){
                resMounth.children[2].innerHTML='<span class="text-success">Так держать! Ваши доходы превышают затраты<span>'
            }
            else if(incomeSumm<costsSumm){
                resMounth.children[2].innerHTML='<span class="text-danger">Ваши расходы превышают доходы, но можно лучше<span>'
            }
            else{
                resMounth.children[2].innerHTML='<span class="text-warning">Не пониманте...<span>'
            }
        }












        //Получение затрат
        async function getCosts(id){
            let tr=db.transaction('costs');
            let costsStore=tr.objectStore('costs');
            if(id){
                let cost=costsStore.get(+id);
                return cost;
            }
            costs=await costsStore.getAll();
            return costs;
        };

        //Получение доходов
        async function getIncomes(id){
            let tr=db.transaction('incomes');
            let incomesStore=tr.objectStore('incomes');
            if(id){
                let income=incomesStore.get(+id);
                return income;
            }
            let incomes=incomesStore.getAll();
            return incomes;
        }

        //Добавление расхода
        async function addCost(obj){
            let tx=db.transaction('costs','readwrite');
            let request =await tx.objectStore('costs').add(obj);
            request.onerror=function(event){
                if(event.error.name=='ConstraintError'){
                    //Позже допишу
                }
            }
        };

        //Изменение расхода
        async function redCost(obj){
            let tx=db.transaction('costs','readwrite');
            let request =await tx.objectStore('costs').put(obj);
            //request.onerror=function(event){
            //    if(event.error.name=='ConstraintError'){
            //        //Позже допишу
            //    }
            //}
        };
        async function redIncome(obj){
            let tx=db.transaction('incomes','readwrite');
            let request =await tx.objectStore('incomes').put(obj);  
        }

        //Добавление дохода
        async function addIncome(obj){
            let tx=db.transaction('incomes','readwrite');
            let request=await tx.objectStore('incomes').add(obj);
            request.onerror=function(event){
                if(event.error.name=='ConstraintError'){
                    //Позже допишу
                }
            }
        }

        //Рандомный id
        function getRandomId(){
            return +(1+Math.random()*(1e6-1)).toFixed();
        }
        //Объекты для добавления

        //Расход
        function createCost(store,category,items){
            let fullPrice;
            //console.log(items);
            if(items.length>1){
                //fullPrice=items.reduce((a,b)=>(+a.price + +b.price));
                fullPrice=summPriceItems(items);
            }
            else{
                fullPrice=items[0].price;
            }
            return {
                id:getRandomId(),
                store:store,
                category:category,
                items:items,
                fullprice:fullPrice,
                date:Date.now(),
            }
        }
        //Доход
        function createIncome(name,amount){
            return {
                id:getRandomId(),
                name:name,
                amount:amount,
                date:Date.now(),
            }
        }

        //График
        let chart;
        async function createChart() {

            let costs=await getCosts();

            let data=new Map();
            for(let i=0;i<costs.length;i++){
                date=new Date(costs[i].date);
                date=getWeekDay(date);

                if(data.has(date)){
                    data.set(date,+data.get(date) + +costs[i].fullprice); 
                }
                else{
                    data.set(date,costs[i].fullprice);
                }
            }
            if(chart){
                chart.destroy();
            }
            var ctx = document.getElementById('chart');

            chart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: Array.from(data.keys()),
                datasets: [{
                  data: Array.from(data.values()),
                  lineTension: 0,
                  backgroundColor: 'transparent',
                  borderColor: '#007bff',
                  borderWidth: 4,
                  pointBackgroundColor: '#007bff'
                }]
              },
              options: {
                scales: {
                  yAxes: [{
                    ticks: {
                      beginAtZero: false
                    }
                  }]
                },
                legend: {
                  display: false
                }
              }
            });
        }

        function getWeekDay(date) {
            let days = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
            return days[date.getDay()];
        }

        
    </script>
</body>
</html>